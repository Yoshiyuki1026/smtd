# すたどら（SMTD）実装計画 v1.2

> Phase 1: 幕下（コア・メカニクス）
> Codename: **The Black Odyssey**

- 作成日: 2026-01-12
- 更新日: 2026-01-13
- 対応仕様書: 仕様書.md v1.2

---

## 1. 実装方針

### 1-1. コアコンセプト

> **「心理的安全性シェルター」** × **「夜のドライブ体験」**

苦痛な「タスク消化」を、深夜のハイウェイを走り抜けるような没入体験に変換する。

### 1-2. 基本方針

| 方針 | 説明 |
|------|------|
| 最小限で動かす | 完璧を目指さず、まず触れる状態を作る |
| ドーパミン優先 | 機能よりも「気持ちよさ」を優先 |
| ローカル完結 | Phase 1では認証・DB不要 |
| 失敗のエンタメ化 | 叱責しない、笑い飛ばす |

### 1-3. 開発の順序

1. **土台** → 型定義、Store
2. **骨格** → 画面レイアウト、基本コンポーネント
3. **魂** → 演出、セリフ
4. **磨き** → 調整、デバッグ

---

## 2. タスク分解

### Step 1: 土台（型定義・Store）

| ID | タスク | 依存 | 見積 |
|----|--------|------|------|
| 1-1 | 型定義ファイル作成（Task, GameState, LunaState） | - | 10min |
| 1-2 | Zustand store作成（taskStore.ts） | 1-1 | 20min |
| 1-3 | セリフデータベース作成（lunaLines.ts）※徳島弁 | - | 15min |

### Step 2: 骨格（基本コンポーネント）

| ID | タスク | 依存 | 見積 |
|----|--------|------|------|
| 2-1 | メイン画面レイアウト（page.tsx）※The Black Odyssey | - | 15min |
| 2-2 | TaskInputコンポーネント | 1-2 | 15min |
| 2-3 | TaskCardコンポーネント | 1-2 | 20min |
| 2-4 | GoalCounterコンポーネント | 1-2 | 10min |

### Step 3: 魂（演出・セリフ）

| ID | タスク | 依存 | 見積 |
|----|--------|------|------|
| 3-1 | LunaToastコンポーネント（ルナのセリフ・トースト表示） | 1-3 | 20min |
| 3-2 | RewardEffectコンポーネント（紙吹雪・ポイント） | 1-2 | 25min |
| 3-3 | セリフ切り替えロジック実装（standard/entertained） | 3-1 | 15min |

### Step 4: 磨き（調整・デバッグ）

| ID | タスク | 依存 | 見積 |
|----|--------|------|------|
| 4-1 | 日付変更ロジック実装 | 1-2 | 15min |
| 4-2 | アニメーション調整 | 3-2 | 20min |
| 4-3 | レスポンシブ対応 | 2-1 | 15min |
| 4-4 | 動作確認・バグ修正 | all | 30min |

---

## 3. 実装順序（依存関係考慮）

```
[並列実行可能]
├── 1-1: 型定義
└── 1-3: セリフデータベース（徳島弁）

↓

1-2: Zustand store（1-1に依存）

↓

[並列実行可能]
├── 2-1: メイン画面レイアウト
├── 2-2: TaskInput
├── 2-3: TaskCard
├── 2-4: GoalCounter
└── 3-1: LunaToast（1-3に依存）

↓

3-2: RewardEffect

↓

3-3: セリフ切り替えロジック（standard/entertained）

↓

[順次実行]
├── 4-1: 日付変更ロジック
├── 4-2: アニメーション調整
├── 4-3: レスポンシブ対応
└── 4-4: 動作確認・バグ修正
```

---

## 4. 実装詳細

### 4-1. 型定義（types/index.ts）

```typescript
// Task
interface Task {
  id: string;
  title: string;
  completed: boolean;
  focused: boolean;      // ← 追加: 今やることに表示するか
  createdAt: string;
  completedAt?: string;
}

// GameState
interface GameState {
  completedToday: number;  // ← 変更: 今日の完了数（ゴール判定用）
  totalStones: number;
  combo: number;
  lastCompletedAt?: string;
  todayDate: string;
}

// Luna
type LunaMode = 'standard' | 'entertained';
type LunaContext = 'ignition' | 'success' | 'failure' | 'idle' | 'bond';

interface LunaState {
  mode: LunaMode;
  context: LunaContext;
  currentLine: string;
}
```

### 4-2. Store設計（stores/taskStore.ts）

```typescript
interface TaskStore {
  // タスク
  tasks: Task[];
  addTask: (title: string) => void;      // 控え室に追加
  completeTask: (id: string) => void;
  deleteTask: (id: string) => void;
  focusTask: (id: string) => void;       // ← 追加: 控え室 → 今やること
  unfocusTask: (id: string) => void;     // ← 追加: 今やること → 控え室

  // ゲーム状態
  gameState: GameState;
  checkDateChange: () => void;  // 日付変更チェック

  // ルナ
  lunaMode: LunaMode;
  lunaContext: LunaContext;
  setLunaContext: (context: LunaContext) => void;

  // 報酬演出
  lastReward: { points: number; combo: number } | null;
  triggerReward: (points: number, combo: number) => void;
  clearReward: () => void;
}
```

**フォーカス操作のルール**:
- `focusTask`: フォーカス済みが3つ未満なら昇格、3つなら何もしない
- `unfocusTask`: 控え室に戻す
- `completeTask`: どちらからでも完了可能（フォーカスは自動解除）

### 4-3. コンポーネント責務

| コンポーネント | 責務 | 状態参照 |
|---------------|------|----------|
| FocusSection | 今やることエリア（最大3タスク） | tasks (focused), completeTask, unfocusTask |
| BacklogSection | 控え室エリア（折り畳み可） | tasks (!focused), focusTask, deleteTask |
| TaskCard | 個別タスク表示・操作 | - |
| TaskInput | タスク追加フォーム（控え室追加） | addTask |
| GoalCounter | ゴール状況表示（3完了で達成） | gameState |
| LunaToast | ルナのセリフ（トースト表示） | lunaMode, lunaContext |
| RewardEffect | 報酬演出オーバーレイ | lastReward |

### 4-4. ルナのモード遷移

| トリガー | LunaMode | LunaContext |
|----------|----------|-------------|
| アプリ起動 | standard | ignition |
| タスク完了 | standard | success |
| タスク削除 | entertained | failure |
| 放置（5分） | standard | idle |
| 深夜帯 or 長時間放置 | entertained | bond |

---

## 5. テスト計画

### 5-1. 手動テスト項目

| # | テスト内容 | 期待結果 |
|---|-----------|----------|
| 1 | タスク追加 | 控え室にタスク追加 |
| 2 | フォーカス昇格（1つ目） | 今やることエリアに表示、スロット更新 |
| 3 | フォーカス昇格（3つ目） | 3/3、控え室の[▲]disabled |
| 4 | フォーカス解除 | 控え室に戻る、スロット空く |
| 5 | タスク完了（今やること） | 紙吹雪、ポイント表示、完了数+1、トーストでsuccessセリフ |
| 6 | タスク完了（控え室） | 同上（控え室からも完了可能） |
| 7 | 連続完了（5分以内） | コンボ表示、倍率適用 |
| 8 | タスク削除 | entertainedモードでfailureセリフ（トースト表示） |
| 9 | 3完了達成 | 「🏆 今日のゴール達成！」表示 |
| 10 | ブラウザリロード | データ維持（localStorage） |
| 11 | 日付変更後アクセス | completedToday/comboリセット、totalStones維持 |
| 12 | アプリ起動時 | ignitionセリフ表示（トースト、徳島弁） |

### 5-2. 確認環境

- Chrome（メイン）
- Safari（iOS PWA想定）
- レスポンシブ（375px〜）

---

## 6. 進捗管理

### 6-1. チェックリスト

- [ ] Step 1: 土台
  - [ ] 1-1: 型定義
  - [ ] 1-2: Zustand store
  - [ ] 1-3: セリフデータベース（徳島弁）
- [ ] Step 2: 骨格
  - [ ] 2-1: メイン画面レイアウト（The Black Odyssey）
  - [ ] 2-2: TaskInput
  - [ ] 2-3: TaskCard
  - [ ] 2-4: GoalCounter
- [ ] Step 3: 魂
  - [ ] 3-1: LunaToast
  - [ ] 3-2: RewardEffect
  - [ ] 3-3: セリフ切り替えロジック（standard/entertained）
- [ ] Step 4: 磨き
  - [ ] 4-1: 日付変更ロジック
  - [ ] 4-2: アニメーション調整
  - [ ] 4-3: レスポンシブ対応
  - [ ] 4-4: 動作確認・バグ修正

### 6-2. 完了条件

1. 全テスト項目がパス
2. ローカルでビルド成功（`npm run build`）
3. Vercelデプロイ成功
4. よっしー自身が「これ使いたい」と思える

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|----------|
| 2026-01-12 | v1.0 | 初版作成 |
| 2026-01-12 | v1.1 | 仕様書v1.1に合わせて更新（LunaMode: standard/entertained、LunaContext: ignition、The Black Odyssey追加） |
| 2026-01-13 | v1.2 | **タスク構造刷新**: 無制限登録 + 3フォーカス。focusTask/unfocusTask追加。勝ち越し→ゴールに変更。ルナのセリフをトースト化。コンポーネント再編（FocusSection, BacklogSection, GoalCounter, LunaToast） |
