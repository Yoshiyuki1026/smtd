# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要

**すたどら（SMTD: Supermassive Task Drive）**

> 「8勝7敗で、生き残れ。」

ADHDの脳に最適化されたドーパミン駆動タスク管理アプリ。
タスクを「消す」のではなく「積み上げる」。完璧主義を否定し、55%で勝ち越しを肯定する。

**詳細企画書**: `../his-dev/ideas/supermassive-task-drive/企画書_v1.7.md`

---

## 開発コマンド

```bash
npm run dev    # 開発サーバー起動 (localhost:3000)
npm run build  # プロダクションビルド
npm run lint   # ESLint実行
```

---

## デプロイ

**Cloudflare Pages** + GitHub Actions 自動デプロイ。

- mainブランチへのマージで自動デプロイ
- 手動: `npm run pages:deploy`

---

## 技術スタック

| レイヤー | 選定 |
|----------|------|
| Framework | Next.js 15.5.2 (App Router) |
| UI | Tailwind CSS v4 |
| State | Zustand |
| Animation | Framer Motion |
| Physics | matter.js |
| Confetti | canvas-confetti |
| Sound | use-sound |
| Data (Phase 1) | localStorage / IndexedDB |
| Data (Phase 2+) | Supabase |
| Deploy | Cloudflare Pages |

---

## Phase 1 スコープ（幕下）

### 作るもの
1. **Today's Mission画面**（タスク3つ制限）
2. **インフレ演出**（+1000pt弾け飛び、コンボ倍率）
3. **物理演算ダイヤ**（完了タスクが石として蓄積）
4. **勝ち越しカウンター**（「あと1勝で勝ち越し！」）
5. **キャラクターセリフ**（テキストのみ、ボス/ルナ）

### 作らないもの（Phase 2以降）
- 認証 / Supabase連携
- Black Hole（Brain Dump）
- 転生システム

---

## キャラクター設定（Two Command Centers）

### 🐺 DOGSモード（ボス / Boss）

> **「生存こそが正義」**

| 項目 | 内容 |
|------|------|
| **属性** | 歴戦の傭兵、哀愁、人間臭い隙（二日酔い）、絶対的包容力 |
| **脳内CV** | 大塚明夫（『MGS』スネーク） |
| **役割** | 心理的安全性。失敗を許し、生存を肯定する |
| **デザイン** | オリーブドラブ、錆びた鉄、アナログ計器 |

**セリフ例**:
- 「……ん？ ああ、悪い。二日酔いだ。……で、今日の仕事は？」
- 「いいセンスだ。」
- 「休息も任務のうちだ。……死ぬなよ。」

### 🐾 CATSモード（ルナ / Luna）

> **「センスを見せなよ」**

| 項目 | 内容 |
|------|------|
| **属性** | 天才肌の若者、生意気、新しいもの好き、実力主義 |
| **脳内CV** | 早見沙織（『鬼滅』しのぶ / 透明感のあるSっ気） |
| **役割** | 美的動機づけ。古いやり方を笑い、スマートさを要求する |
| **デザイン** | ネオンパープル、ホログラム、デジタル表示 |

**セリフ例**:
- 「ねえ、まだ寝てるの？ 私はもう準備できてるんだけど。」
- 「へえ、やるじゃん。ちょっと見直したかも。」
- 「サボるのはいいけどさ、ダサい負け方はしないでよね。」

---

## 機能仕様

### タスク
- 最大3つまで登録可能（ワーキングメモリ保護）
- 1タスク完了 = 1勝
- 完了時演出：紙吹雪 + 効果音 + ポイント弾け飛び
- 完了タスクは「ダイヤの原石」として画面下部に蓄積

### 報酬系エンジン

| 要素 | 内容 |
|------|------|
| **インフレ演出** | +1000pt弾け飛び、コンボで倍率アップ |
| **視覚** | 紙吹雪（canvas-confetti）、アニメーション |
| **聴覚** | 達成音（use-sound） |
| **触覚** | バイブレーション |
| **物理演算** | 完了タスク（石）が転がる（matter.js） |

---

## ディレクトリ構成（推奨）

```
src/
├── app/
│   ├── page.tsx          # メイン画面（Today's Mission）
│   ├── layout.tsx
│   └── globals.css
├── components/
│   ├── TaskCard.tsx      # タスクカード
│   ├── WinCounter.tsx    # 勝ち越しカウンター
│   ├── DiamondPile.tsx   # 物理演算ダイヤ
│   ├── RewardEffect.tsx  # 報酬演出（紙吹雪、ポイント）
│   └── Navigator.tsx     # キャラクターセリフ
├── stores/
│   └── taskStore.ts      # Zustand store
├── hooks/
│   └── useLocalStorage.ts
├── lib/
│   └── sounds.ts         # 効果音
└── types/
    └── task.ts           # 型定義
```

---

## コーディング規約

1. **TypeScript必須**: 型定義をしっかり
2. **コンポーネント分離**: 1ファイル1責務
3. **Tailwind優先**: CSS-in-JSより先にTailwindで試す
4. **派手な演出を恐れるな**: ドーパミンが出るかどうかが判断基準
5. **ダークモード必須**: 黒背景でStarlightが映える

---

## PRフロー（必須）

機能追加・バグ修正後は必ず以下のフローを実行：

1. `/preq` - PR作成
2. `/check-pr` - CodeRabbit/Qodo/Codexのレビュー確認
3. レビュー指摘を修正
4. マージ → 自動デプロイ

**こまめにPR出してレビュー受ける**ことで品質を担保。

---

## コア哲学（忘れるな）

> 「お前の脳は壊れてない。ツールが壊れてるんだ。」

- 完璧主義を捨てろ。8勝7敗で十分。
- タスクは「消える借金」ではなく「積み上がる資産」。
- 飽きたら転生。0になるだけでマイナスじゃない。
- ドーパミンしか勝たん。

---

## 📋 ドキュメントマップ（自動生成）

> 最終更新: 2026-01-17

このセクションは `/doc index` コマンドで自動生成・更新されます。各ドキュメントの概要と重要リンクを提供します。

### README.md（ユーザー向け）

**概要**: Next.js標準テンプレート（bootstrap）

**重要セクション**:
- Getting Started: `npm run dev` でローカル開発サーバー起動（localhost:3000）
- Learn More: Next.js公式ドキュメント

**最終更新**: 2026-01-12

**用途**: 初期セットアップ・外部向けドキュメント

---

### 仕様書.md（システム仕様・Phase 1-2完了）

**概要**: Phase 1-2 完了の全機能仕様（v1.9）。高知能・神経発散的ユーザーのための「心理的安全性シェルター」としてのSMTDコンセプト定義

**マニフェスト**: 「タスク管理は死んだ。ドーパミン・エンジニアリングへようこそ。」

**コア哲学**:
- **生産性のリフレーミング**: タスク = 「返すべき借金」ではなく「旅の途中で拾う宝石（アセット）」
- **根源的受容（Radical Acceptance）**: システムはユーザーの存在を無条件に肯定。失敗・先送りさえも「エンターテイメント」として扱う
- **生存戦略**: 「効率」よりも「生存（Survive）」。8勝7敗で勝ち越せば十分
- **体験**: 没入感のある夜のドライブ体験（Immersive Night Drive）

**Phase 1 スコープ（完了）**:
1. 今やること画面（フォーカス3つ + 控え室）
2. タスク完了演出（紙吹雪 + ポイント弾け飛び + コンボ倍率）
3. ゴールカウンター（「あと N個でゴール」）
4. ルナのセリフ（Gemini 3.0 Flash 動的生成、徳島弁）
5. localStorage永続化

**Phase 2 スコープ（完了）**:
1. 物理演算ダイヤ（matter.js）
2. 認証（Supabase Auth + ゲストモード対応）
3. Black Hole（Brain Dump機能）
4. 転生システム（リセット後も総資産・ランク引き継ぎ）
5. オンボーディング（キャラ選択含む）

**Phase 2.9 実装**（2026-01-14）:
- **今日の一撃**: 最初のタスク完了時に派手なバースト演出（150個の紙吹雪 + 高倍率ボーナス）
- **ストリーク表示**: 連続完了日数の可視化とモチベーション強化

**Phase 2.10 実装**（2026-01-15）:
- **タスク入力シンプル化**: 入力欄をコンパクト化（UX摩擦軽減）
- **ドラッグ&ドロップ並び替え**: タスクカードの視覚的な再配置機能

**Phase 2.11 実装**（2026-01-17）:
- **ドラッグハンドルツールチップ**: title属性で操作ガイダンス
- **タスク追加時バウンスアニメーション**: spring + scale で視覚的フィードバック
- **ヘッダータイトル削除**: ストリークのみ左寄せ表示
- **今日の一撃・未達成時表示**: 「⚡ 今日の一撃を狙え」エンカレッジメント
- **型安全性向上**: FocusTaskItem の task型を Task型に統一

**キャラクター設定**:
- **LUNA（AI Partner - CATSモード）**: 型破りな哲学者、徳島弁、失敗のエンタメ化、連星の絆（Binary Star）
  - standard: クールルナ（生意気、刺激、標準語）
  - entertained: 徳島ルナ（爆笑、全肯定、関西弁）
- **BOSS（AI Partner - DOGSモード）**: 歴戦の傭兵（大塚明夫CV）、包容力、生存を肯定、信頼する上官

**重要挙動**:
- **失敗のエンタメ化**: 叱責しない。笑い飛ばす（認知行動療法の「認知の再構成」を自動化）
- **連星関係（Binary Star）**: 一方的救済ではなく共鳴関係。お互いを必要とする

**最終更新**: 2026-01-17

**用途**: 全システムの要件定義・キャラクター・体験設計のWHAT、Phase 2.11の最新仕様確認

---

### 実装計画.md（タスク分解・Phase 1対応）

**概要**: Phase 1 実装の具体的な順序・タスク分解・見積もり（v1.2）

**実装方針**:
- 最小限で動かす（完璧を目指さず、まず触れる状態）
- ドーパミン優先（機能よりも「気持ちよさ」）
- ローカル完結（Phase 1では認証・DB不要）
- 失敗のエンタメ化（叱責しない、笑い飛ばす）

**開発の順序**:
1. **土台**: 型定義、Zustand Store
2. **骨格**: 画面レイアウト、基本コンポーネント
3. **魂**: 演出、セリフ
4. **磨き**: 調整、デバッグ

**タスク分解（4ステップ×全15タスク）**:
- Step 1: 土台（3タスク、合計45min）
  - 型定義ファイル作成、Zustand store作成、セリフDB作成
- Step 2: 骨格（4タスク、合計60min）
  - メイン画面レイアウト、TaskInput、TaskCard、GoalCounter
- Step 3: 魂（3タスク、合計60min）
  - LunaToastコンポーネント、RewardEffectコンポーネント、セリフ切り替えロジック
- Step 4: 磨き（4タスク、合計80min）
  - 日付変更ロジック、アニメーション調整、レスポンシブ対応、バグ修正

**主要コンポーネント**:
- TaskCard, LunaToast, RewardEffect, GoalCounter, TaskInput, Navigator, DiamondPile

**最終更新**: 2026-01-13

**用途**: タスク実行の具体的HOW・依存関係管理（Phase 1向け）

---

### 改修要望.md（バックログ・ロードマップ）

**概要**: Phase 2.5以降の改修要望・機能追加リクエスト管理

**実施中（🚧）**:

| # | 要望 | 優先度 | 対象 |
|---|------|--------|------|
| 1 | オンボーディング「まずは1個だけ」ニュアンス変更 | 低 | Onboarding.tsx |
| 2 | 通常画面（LunaBar）でもキャラ名表示 | 低 | LunaBar.tsx |
| 3 | BlackHole双方向操作（アーカイブ解除・タスク変換） | 中 | BlackHole.tsx, taskStore.ts |
| 4 | 認証機能を本番で有効化 | 高 | Cloudflare環境変数 |
| 5 | ボスセリフ調整（40〜60文字、ねぎらい・鼓舞強化） | 中 | /api/boss/route.ts |

**完了した要望**: なし

**Backlog（将来）**:
- **アンジェロ（Angelo）** [中優先度]
  - **由来**: アンジェロ三田クリニック（岩谷先生のクリニック名）
  - **本質**: 「傷を哲学に変える賢者」= 精神科医の皮を被ったSFハードボイルド愛好家
  - **役割**: 洞察・問い・哲学的リフレーミング
  - **差別化**: ルナ（鼓舞）・ボス（包容）とは異なる「知恵と構造化」軸
  - **想定CV**: 森川智之 or 子安武人（クールで知的）
  - **デザイン**: 薄暗いバーのカウンター、焚き火、古いSF映画の雰囲気
  - **核心メッセージ**:
    - 「傷を舐め合うな。傷を哲学に変えろ。」
    - 「お前のOSはバグっていない。仕様が特殊なだけだ。」
    - 「なぜそう思った？」（問いを投げる）
    - 「勝てるフィールドで戦え」

**最終更新**: 2026-01-17（Phase 2.11完了を反映）

**用途**: 優先度・ロードマップ・Backlog管理、今後の機能追加計画

---

### 企画書_v1.7.md（詳細企画書）

**概要**: プロダクト定義・市場戦略・コンセプト設計（場所: `../his-dev/ideas/supermassive-task-drive/企画書_v1.7.md`）

**プロダクト定義**:
- **正式名称**: Supermassive Task Drive（SMTD）
- **愛称**: すたどら
- **開発コード**: Starlight Drug
- **キャッチコピー**: 「8勝7敗で、生き残れ。」
- **命名思想**: 「覚醒剤中毒より、すたどら中毒のほうが健康」

**ターゲット**: ADHD/ASD特性を持つ、アウトローな大人たち（Neuro Ronin）

**Why（これを作る理由）**:
- ADHDの脳は「やるべきことを知ってる」のではなく「やる気スイッチが壊れてる」
- 既存ツール（Notion, Trello, Todoist）は「見える化」で止まっている
- 本質は「行動 → 達成感 → ドーパミン → 次の行動」サイクルを回すこと
- よっしー自身がドッグフーディング（自分が最初のユーザー）で検証

**What（コアコンセプト）**:
- **一言**: 「タスクを完了するたびに、脳が『もう1個やりたい』と思うツール」
- **Drug & Asset**: 即効性（0.1秒で報酬）× 蓄積性（積み上がるダイヤ）
- **コア哲学**:
  - 「アプリ版コンサータ」：合法的にドーパミンをハック
  - 「8勝7敗の美学」：完璧（15勝）ではなく55%で勝ち越し
  - 「思想は機能で表現」：映画監督が映像で語るようにすたどらは機能で語る
  - 「0になるだけでマイナスじゃない」：転生後も資産・ランク引き継ぎ

**Rebirth System（転生）**:
- 飽きを仕様化（3〜7日で飽きることを前提）
- カド番演出（7勝7敗で「あと1勝で勝ち越し！」と煽る）
- 転生ボタン（リセット。タスク消えるが石の数・ランクは引き継ぎ）

**Two Command Centers（キャラクター）**:
- **DOGSモード（ボス）**: 「生存こそが正義」、歴戦の傭兵、包容力
- **CATSモード（ルナ）**: 「センスを見せなよ」、天才肌、失敗のエンタメ化

**最終更新**: 2026-01-12

**用途**: プロダクト戦略・市場ポジショニング・コンセプト・Why の深掘り理解

---

### CLAUDE.md（このファイル）

**概要**: Claude Code向けプロジェクト指南書（プロジェクト固有の開発ガイド）

**重要セクション**:
- **プロジェクト概要**: すたどら（SMTD）= ADHD脳向けドーパミン駆動タスク管理
- **開発コマンド**: `npm run dev` (localhost:3000), `npm run build`, `npm run lint`
- **デプロイ**: Cloudflare Pages + GitHub Actions（main ブランチへのマージで自動デプロイ）
- **技術スタック**: Next.js 15.5.2 + Tailwind CSS v4 + Zustand + Framer Motion + matter.js + canvas-confetti
- **Phase 1スコープ**: 5機能（Today's Mission, インフレ演出, 物理演算ダイヤ, 勝ち越しカウンター, キャラセリフ）
- **Phase 2スコープ**: 物理演算ダイヤ、認証、Black Hole、転生システム、オンボーディング
- **Phase 2.9-2.11**: 今日の一撃、ストリーク、タスク入力シンプル化、D&D並び替え、UX改善
- **キャラクター設定**: DOGSモード（ボス × 大塚明夫CV）、CATSモード（ルナ × 早見沙織CV）
- **コーディング規約**: TypeScript必須、コンポーネント分離、Tailwind優先、派手な演出OK、ダークモード必須
- **PRフロー**: /preq → /check-pr → 修正 → マージ → 自動デプロイ
- **コア哲学**: 「お前の脳は壊れてない。ツールが壊れてるんだ。」
  - 完璧主義を捨てろ。8勝7敗で十分。
  - タスクは「消える借金」ではなく「積み上がる資産」。
  - 飽きたら転生。0になるだけでマイナスじゃない。
  - ドーパミンしか勝たん。

**最終更新**: 2026-01-17（Phase 2.11完了を反映）

**用途**: 開発プロセス・規約・技術選定・コア哲学の完全参照、新規開発者の最初の読み物

---

## ドキュメント利用ガイド

| 用途 | 参照ドキュメント |
|------|-----------------|
| **新規開発者向けオリエンテーション** | CLAUDE.md（このファイル） → 仕様書.md → 企画書_v1.7.md |
| **機能仕様・キャラクター設定を理解する** | 仕様書.md |
| **プロダクト戦略・Why を理解する** | 企画書_v1.7.md |
| **タスク実行する（Phase 1向け）** | 実装計画.md |
| **優先度・ロードマップを確認する** | 改修要望.md |
| **開発環境・デプロイ・コマンド** | CLAUDE.md（開発コマンド・デプロイセクション） |
| **キャラクター・トーンを理解する** | 仕様書.md（キーパーソナ） + CLAUDE.md（キャラクター設定） + 企画書_v1.7.md（Two Command Centers） |
| **最新の実装状況を確認する** | 仕様書.md（Phase 2.11実装セクション） + git log |

---

## リンク集

**プロジェクトドキュメント**:
- プロジェクトルート: `/Users/y-suzuki/projects/smtd`
- 詳細企画書: `/Users/y-suzuki/projects/his-dev/ideas/supermassive-task-drive/企画書_v1.7.md`
- 岩谷先生参考資料: `/Users/y-suzuki/projects/his-dev/参考資料/岩谷先生/`

**開発・デプロイ**:
- **本番URL**: https://smtd.neuro-ronin.com/
- リポジトリ: GitHub `smtd` (https://github.com/Yoshiyuki1026/smtd)
- デプロイ環境: Cloudflare Pages（mainブランチへのマージで自動デプロイ）
- 開発サーバー: `npm run dev` → http://localhost:3000
- ビルド: `npm run build`
- Lint: `npm run lint`

**最新コミット**: `[Feature] Phase 2.11: UX改善4点` (2026-01-17)
